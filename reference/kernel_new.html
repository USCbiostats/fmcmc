<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Transition Kernels for MCMC — kernel_new • fmcmc</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Transition Kernels for MCMC — kernel_new"><meta property="og:description" content="The function kernel_new is a helper function that allows creating
fmcmc_kernel objects which are passed to the MCMC() function."><meta property="og:image" content="/logo.svg"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-108627422-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-108627422-3');
</script></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fmcmc</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.5-2.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/advanced-features.html">Advanced features</a>
    </li>
    <li>
      <a href="../articles/user-defined-kernels.html">User-defined kernels</a>
    </li>
    <li>
      <a href="../articles/workflow-with-fmcmc.html">Workflow with fmcmc</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/USCbiostats/fmcmc/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Transition Kernels for MCMC</h1>
    <small class="dont-index">Source: <a href="https://github.com/USCbiostats/fmcmc/blob/HEAD/R/kernel.R" class="external-link"><code>R/kernel.R</code></a></small>
    <div class="hidden name"><code>kernel_new.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>The function <code>kernel_new</code> is a helper function that allows creating
<code>fmcmc_kernel</code> objects which are passed to the <code><a href="MCMC.html">MCMC()</a></code> function.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">kernel_new</span><span class="op">(</span><span class="va">proposal</span>, <span class="va">...</span>, logratio <span class="op">=</span> <span class="cn">NULL</span>, kernel_env <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span>hash <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>proposal, logratio</dt>
<dd><p>Functions. Both receive a single argument, an environment.
This functions are called later within <a href="MCMC.html">MCMC</a> (see details).</p></dd>


<dt>...</dt>
<dd><p>In the case of <code>kernel_new</code>, further arguments to be stored with
the kernel.</p></dd>


<dt>kernel_env</dt>
<dd><p>Environment. This will be used as the main container of the
kernel's components. It is returned as an object of class <code>c("environment", "fmcmc_kernel")</code>.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p>An environment of class <code>fmcmc_kernel</code> which contains the following:</p><ul><li><p><code>proposal</code> A function that receives a single argument, an environment. This
is the proposal function used within <code><a href="MCMC.html">MCMC()</a></code>.</p></li>
<li><p><code>logratio</code> A function to compute log ratios of the current vs the proposed
step of the chain. Also used within <code><a href="MCMC.html">MCMC()</a></code>.</p></li>
<li><p><code>...</code> Further arguments passed to <code>kernel_new</code>.</p></li>
</ul></div>
    <div id="details">
    <h2>Details</h2>
    <p>The objects <code>fmcmc_kernels</code> are environments that in general contain the
following objects:</p><ul><li><p><code>proposal</code>: The function used to propose changes in the chain based
on the current state. The function must return a vector of length equal
to the number of parameters in the model.</p></li>
<li><p><code>logratio</code>: This function is called after a new state has been proposed,
and is used to compute the log of the Hastings ratio.</p>
<p>In the case that the <code>logratio</code> function is not specified, then it is assumed
that the transition kernel is symmetric, this is, log-ratio is then implemented
as <code>function(env) {env$f1 - env$f0}</code></p></li>
<li><p><code>...</code>: Further objects that are used within those functions.</p></li>
</ul><p>Both functions, <code>proposal</code> and <code>logratio</code>, receive a single argument, an
environment, which is passed by the <code><a href="MCMC.html">MCMC()</a></code> function during each step using
the function <code><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment()</a></code>.</p>
<p>The passed environment is actually the environment in which the <code>MCMC</code>
function is running, in particular, this environment contains the following
objects:</p>
<table class="table table"><tr><td><strong>Object</strong></td><td></td><td><strong>Description</strong></td></tr><tr><td><code>i</code></td><td></td><td>Integer. The current iteration.</td></tr><tr><td><code>theta1</code></td><td></td><td>Numeric vector. The last proposed state.</td></tr><tr><td><code>theta0</code></td><td></td><td>Numeric vector. The current state</td></tr><tr><td><code>f</code></td><td></td><td>The log-unnormalized posterior function (a wrapper of <code>fun</code> passed
to <a href="MCMC.html">MCMC</a>).</td></tr><tr><td><code>f1</code></td><td></td><td>The last value of <code>f(theta1)</code></td></tr><tr><td><code>f0</code></td><td></td><td>The last value of <code>f(theta0)</code></td></tr><tr><td><code>kernel</code></td><td></td><td>The actual <code>fmcmc_kernel</code> object.</td></tr><tr><td><code>ans</code></td><td></td><td>The matrix of samples defined up to <code>i - 1</code>.</td></tr></table><p>These are the core component of the <code>MCMC</code> function. The following block
of code is how this is actually implemented in the package:</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> 1L<span class="sc">:</span>nsteps) {</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  <span class="co"># Step 1. Propose</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>  theta1[] <span class="ot">&lt;-</span> kernel<span class="sc">$</span><span class="fu">proposal</span>(<span class="fu">environment</span>())</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>  f1       <span class="ot">&lt;-</span> <span class="fu">f</span>(theta1)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>  </span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>  <span class="co"># Checking f(theta1) (it must be a number, can be Inf)</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">is.nan</span>(f1) <span class="sc">|</span> <span class="fu">is.na</span>(f1) <span class="sc">|</span> <span class="fu">is.null</span>(f1)) </span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>    <span class="fu">stop</span>(</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>      <span class="st">"fun(par) is undefined ("</span>, f1, <span class="st">")"</span>,</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>      <span class="st">"Check either -fun- or the -lb- and -ub- parameters."</span>,</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>      <span class="at">call. =</span> <span class="cn">FALSE</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>    )</span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>  </span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>  <span class="co"># Step 2. Hastings ratio</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>  <span class="cf">if</span> (R[i] <span class="sc">&lt;</span> kernel<span class="sc">$</span><span class="fu">logratio</span>(<span class="fu">environment</span>())) {</span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>    theta0 <span class="ot">&lt;-</span> theta1</span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>    f0     <span class="ot">&lt;-</span> f1</span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>  }</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a>  </span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>  <span class="co"># Step 3. Saving the state</span></span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a>  ans[i,] <span class="ot">&lt;-</span> theta0</span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a>  </span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a>}</span></code></pre><p></p></div>
<p>For an extensive example on how to create new kernel objects see the vignette
<code><a href="../articles/user-defined-kernels.html">vignette("user-defined-kernels", "fmcmc")</a></code>.</p>
    </div>
    <div id="behavior">
    <h2>Behavior</h2>
    


<p>In some cases, calls to the <code>proposal()</code> and <code>logratio()</code> functions in
<code>fmcmc_kernels</code> can trigger changes or updates of variables stored within them.
A concrete example is with adaptive kernels.</p>
<p>Adaptive Metropolis and Robust Adaptive Metropolis implemented in the functions
<code><a href="kernel_adapt.html">kernel_adapt()</a></code> and <code><a href="kernel_ram.html">kernel_ram()</a></code> both update a covariance matrix used
during the proposal stage, and furthermore, have a <code>warmup</code> stage that sets
the point at which both will start adapting. Because of this, both kernels
have internal counters of the absolute step count which allows them activating,
scaling, etc. the proposals correctly.</p><ol><li><p>When running multiple chains, <code>MCMC</code> will create independent copies of a
baseline passed <code>fmcmc_kernel</code> object. These are managed together in a
<code>fmcmc_kernel_list</code> object.</p></li>
<li><p>Even if the chains are run in parallel, if a predefined kernel object is
passed it will be updated to reflect the last state of the kernels
before the <code>MCMC</code> call returns.</p></li>
</ol></div>
    <div id="references">
    <h2>References</h2>
    <p>Brooks, S., Gelman, A., Jones, G. L., &amp; Meng, X. L. (2011). Handbook of
Markov Chain Monte Carlo. Handbook of Markov Chain Monte Carlo.</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p>Other kernels: 
<code><a href="kernel_adapt.html">kernel_adapt</a>()</code>,
<code><a href="kernel_mirror.html">kernel_mirror</a></code>,
<code><a href="kernel_normal.html">kernel_normal</a>()</code>,
<code><a href="kernel_ram.html">kernel_ram</a>()</code>,
<code><a href="kernel_unif.html">kernel_unif</a>()</code></p></div>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example creating a multivariate normal kernel using the mvtnorm R package</span></span></span>
<span class="r-in"><span><span class="co"># for a bivariate normal distribution</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://mvtnorm.R-forge.R-project.org" class="external-link">mvtnorm</a></span><span class="op">)</span></span></span>
<span class="r-err co"><span class="r-pr">#&gt;</span> <span class="error">Error in library(mvtnorm):</span> there is no package called ‘mvtnorm’</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Define your Sigma</span></span></span>
<span class="r-in"><span><span class="va">sigma</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">.2</span>, <span class="fl">.2</span>, <span class="fl">1</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># How does it looks like?</span></span></span>
<span class="r-in"><span><span class="va">sigma</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      [,1] [,2]</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1,]  1.0  0.2</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [2,]  0.2  1.0</span>
<span class="r-in"><span><span class="co">#      [,1] [,2]</span></span></span>
<span class="r-in"><span><span class="co"># [1,]  1.0  0.2</span></span></span>
<span class="r-in"><span><span class="co"># [2,]  0.2  1.0</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Create the kernel</span></span></span>
<span class="r-in"><span><span class="va">kernel_mvn</span> <span class="op">&lt;-</span> <span class="fu">kernel_new</span><span class="op">(</span></span></span>
<span class="r-in"><span>  proposal <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">env</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">env</span><span class="op">$</span><span class="va">theta0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="fu">mvtnorm</span><span class="fu">::</span><span class="fu">rmvnorm</span><span class="op">(</span><span class="fl">1</span>, mean <span class="op">=</span> <span class="fl">0</span>, sigma <span class="op">=</span> <span class="va">sigma.</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span>,</span></span>
<span class="r-in"><span>  sigma. <span class="op">=</span> <span class="va">sigma</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># As you can see, in the previous call we passed sigma as it will be used by</span></span></span>
<span class="r-in"><span><span class="co"># the proposal function</span></span></span>
<span class="r-in"><span><span class="co"># The logaratio function was not necesary to be passed since this kernel is</span></span></span>
<span class="r-in"><span><span class="co"># symmetric.</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by George Vega Yon, National Cancer Institute (NCI).</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

